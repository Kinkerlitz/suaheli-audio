<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Suaheli intensiv</title>
    
    <link rel="icon" type="image/png" href="cover.386x491.png">
    
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- Styles f√ºr den Trainer-Modus --- */
        #version-display {
            position: fixed;
            top: 3px;
            left: 3px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 2px 6px;
            font-size: 10px;
            border-radius: 4px;
            z-index: 9999;
        }
        .play-btn {
            background: transparent; /* Kein fester Hintergrund */
            color: #3498db; /* Farbe des Play-Symbols */
            border: 2px solid #3498db; /* Rand in der gleichen Farbe */
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1rem; /* Etwas kleineres Symbol */
            padding: 0; /* Wichtig f√ºr die Zentrierung */
            cursor: pointer;
            display: flex; /* Flexbox f√ºr Zentrierung nutzen */
            align-items: center; /* Vertikal zentrieren */
            justify-content: center; /* Horizontal zentrieren */
            transition: all 0.2s ease; /* Sanfter √úbergang */
        }
        .play-btn:hover { 
            background: #3498db; /* F√ºllt sich beim Dar√ºberfahren */
            color: white; /* Symbol wird wei√ü */
        }
        body { padding-bottom: 160px; }

        input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 10px;
            cursor: pointer;
        }

        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #2c3e50;
            color: white;
            padding: 10px 5px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
        }

        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .control-btn {
            background: #34495e;
            border: 1px solid #7f8c8d;
            color: white;
            padding: 8px 2px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 0;
            transition: background 0.2s;
        }

        .control-btn:active { background: #1abc9c; }
        .control-btn.active-play { background: #16a085; border-color: #1abc9c; font-weight: bold; }
        .control-btn.loop-on { background: #d35400; border-color: #e67e22; font-weight: bold; }
        .control-btn span { font-size: 1.1rem; display: block; margin-bottom: 2px; }

        .status-bar {
            text-align: center;
            font-size: 0.9rem;
            color: #ecf0f1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;
            margin-bottom: 5px;
        }

        .playing-row {
            background-color: #d5f5e3 !important;
            border-left: 5px solid #2ecc71;
        }

        /* Korrektur f√ºr die neuen Auswahl-Zeilen */
        .select-all-row {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #eee;
            border-bottom: 1px solid #ccc;
            margin-bottom: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        summary { display: flex; align-items: center; font-weight: bold; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="version-display">v1.4</div>

<div class="container">
    <header>
        <h1>Suaheli intensiv</h1>
        <p><a href="index.html" style="color:white;">&larr; Zur√ºck</a></p>
    </header>

    <div class="content" id="audioContainer">
        <div style="text-align:center; padding:20px;">Lade Daten...</div>
    </div>
</div>

<div class="control-bar">
    <div class="status-bar" id="statusText">Bitte Auswahl treffen...</div>
    <div class="control-buttons">
        <button class="control-btn" id="btn-normal" onclick="startPlaylist('normal')">
            <span>‚ñ∂</span> Start
        </button>
        
        <button class="control-btn" id="btn-loop" onclick="toggleLoop()">
            <span>üîÅ</span> Loop
        </button>

        <button class="control-btn" id="btn-shuffle" onclick="startPlaylist('shuffle')">
            <span>üîÄ</span> Zufall
        </button>

        <button class="control-btn" onclick="changeSpeed()">
            <span id="speed-icon">1.0x</span> Tempo
        </button>

        <button class="control-btn" onclick="stopPlayback()" style="background:#c0392b; border-color:#a93226;">
            <span>‚èπ</span> Stop
        </button>
        
        <button class="control-btn" onclick="resetCheckboxes()" style="background:#7f8c8d; border-color:#95a5a6;">
            <span>‚òí</span> Reset
        </button>
    </div>
</div>

<script src="audio_data.js"></script>

<script>
    try {
        const container = document.getElementById('audioContainer');
        const statusText = document.getElementById('statusText');
        const playlistPlayer = new Audio();
        
        let playlist = [];       
        let currentTrackIndex = 0;
        let playbackMode = 'normal'; 
        let isPlaylistPlaying = false;
        let isLoopActive = false;
        let currentSpeed = 1.0;
        let currentSingleAudio = null;

        const speedOptions = [0.75, 1.0, 1.25, 1.5]; 

        function renderAudioContent() {
            container.innerHTML = ''; 

            const chapters = Object.keys(audioData).sort((a, b) => 
                a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
            );

            chapters.forEach(chapterKey => {
                const chapterDetails = document.createElement('details');
                const chapterSummary = document.createElement('summary');
                chapterSummary.textContent = "Kapitel " + chapterKey;
                chapterDetails.appendChild(chapterSummary);

                const chapterContent = document.createElement('div');
                chapterContent.style.paddingLeft = "10px";

                // "Alle ausw√§hlen" f√ºr das gesamte Kapitel
                const chapSelectAll = document.createElement('label');
                chapSelectAll.className = 'select-all-row';
                chapSelectAll.innerHTML = `<input type="checkbox" class="chap-cb"> Kapitel ${chapterKey} (Alle w√§hlen)`;
                chapSelectAll.querySelector('input').onclick = (e) => toggleChildren(e, chapterDetails);
                chapterContent.appendChild(chapSelectAll);

                const tables = Object.keys(audioData[chapterKey]).sort((a, b) => {
                    const isVokA = a.includes('Vok');
                    const isVokB = b.includes('Vok');
                    if (isVokA && !isVokB) return -1;
                    if (!isVokA && isVokB) return 1;
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                });

                tables.forEach(tableKey => {
                    const tableDetails = document.createElement('details');
                    const tableSummary = document.createElement('summary');

                    let displayName = tableKey;
                    if (tableKey.includes('Vok')) {
                        const parts = tableKey.split('-');
                        displayName = parts.length > 1 ? "Vokabeln " + parts[1] : "Vokabeln";
                        tableSummary.style.color = "#d35400"; 
                    } else {
                        displayName = "Tabelle " + tableKey;
                    }

                    tableSummary.textContent = displayName;
                    tableDetails.appendChild(tableSummary);

                    const tableContent = document.createElement('div');
                    tableContent.style.padding = "10px";
                    tableContent.style.backgroundColor = "#f9f9f9";

                    // "Alle ausw√§hlen" f√ºr diese Tabelle
                    const tableSelectAll = document.createElement('label');
                    tableSelectAll.className = 'select-all-row';
                    tableSelectAll.style.background = "#e1e1e1";
                    tableSelectAll.innerHTML = `<input type="checkbox" class="table-cb"> ${displayName} (Alle w√§hlen)`;
                    tableSelectAll.querySelector('input').onclick = (e) => toggleChildren(e, tableDetails);
                    tableContent.appendChild(tableSelectAll);

                    const tracks = audioData[chapterKey][tableKey];
                    tracks.forEach(track => {
                        const row = document.createElement('div');
                        row.className = 'audio-row';
                        row.id = 'row-' + convertPathToId(track.path);

                        const trackCheckbox = document.createElement('input');
                        trackCheckbox.type = "checkbox";
                        trackCheckbox.className = "track-cb";
                        trackCheckbox.value = track.path;
                        trackCheckbox.dataset.label = displayName + " - " + track.index; 

                        const label = document.createElement('span');
                        label.className = 'audio-label';
                        label.textContent = track.index + ".";

                        const playButton = document.createElement('button');
                        playButton.className = 'play-btn';
                        playButton.innerHTML = '&#9654;'; // Play symbol
                        playButton.onclick = () => {
                            window.stopPlayback();
                            playlistPlayer.src = track.path;
                            playlistPlayer.playbackRate = currentSpeed;
                            playlistPlayer.play();
                            statusText.textContent = track.label;
                            highlightRow(row.id);
                        };

                        row.appendChild(trackCheckbox);
                        row.appendChild(label);
                        row.appendChild(playButton);
                        tableContent.appendChild(row);
                    });

                    tableDetails.appendChild(tableContent);
                    chapterContent.appendChild(tableDetails);
                });

                chapterDetails.appendChild(chapterContent);
                container.appendChild(chapterDetails);
            });
        }

        function toggleChildren(e, parentElement) {
            e.stopPropagation(); 
            const isChecked = e.target.checked;
            parentElement.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = isChecked);
        }

        window.resetCheckboxes = function() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            statusText.textContent = "Auswahl aufgehoben.";
            playlist = [];
            window.stopPlayback();
        };

        window.changeSpeed = function() {
            let index = speedOptions.indexOf(currentSpeed);
            index = (index + 1) % speedOptions.length;
            currentSpeed = speedOptions[index];
            const icon = document.getElementById('speed-icon');
            if(icon) icon.textContent = currentSpeed + "x";
            if (playlistPlayer) playlistPlayer.playbackRate = currentSpeed;
            playlistPlayer.playbackRate = currentSpeed;
        };

        window.toggleLoop = function() {
            isLoopActive = !isLoopActive;
            const btnLoop = document.getElementById('btn-loop');
            if (btnLoop) btnLoop.classList.toggle('loop-on', isLoopActive);
        };

        window.startPlaylist = function(mode) {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.track-cb:checked'));
            if (selectedCheckboxes.length === 0) {
                alert("Bitte w√§hlen Sie zuerst Audio-Dateien aus.");
                return;
            }
            window.stopPlayback();
            
            playlist = selectedCheckboxes.map(cb => ({
                path: cb.value,
                label: cb.dataset.label,
                domId: 'row-' + convertPathToId(cb.value)
            }));
            playbackMode = mode;
            updatePlayButtonStyles(mode);
            if (mode === 'shuffle') shuffleArray(playlist);
            currentTrackIndex = 0;
            isPlaylistPlaying = true;
            playNext();
        };

        window.stopPlayback = function() {
            isPlaylistPlaying = false;
            playlistPlayer.pause();
            if (currentSingleAudio) {
                currentSingleAudio.pause();
                currentSingleAudio = null;
            }
            statusText.textContent = "Gestoppt.";
            removeHighlights();
            updatePlayButtonStyles(null);
        };

        function convertPathToId(path) {
            return path.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function playNext() {
            if (!isPlaylistPlaying) return;
            if (currentTrackIndex >= playlist.length) {
                if (isLoopActive) {
                    currentTrackIndex = 0;
                } else {
                    window.stopPlayback();
                    statusText.textContent = "Wiedergabe beendet.";
                    return;
                }
            }
            const track = playlist[currentTrackIndex];
            highlightRow(track.domId);
            statusText.textContent = track.label;
            playlistPlayer.src = track.path;
            playlistPlayer.playbackRate = currentSpeed;
            playlistPlayer.play().catch(e => console.log("Fehler:", e));
            playlistPlayer.onended = () => {
                currentTrackIndex++;
                playNext();
            };
        }

        function highlightRow(domId) {
            removeHighlights();
            const row = document.getElementById(domId);
            if (row) {
                row.classList.add('playing-row');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function removeHighlights() {
            document.querySelectorAll('.playing-row').forEach(el => el.classList.remove('playing-row'));
        }

        function updatePlayButtonStyles(activeMode) {
            const btnNormal = document.getElementById('btn-normal');
            const btnShuffle = document.getElementById('btn-shuffle');
            if(btnNormal) btnNormal.classList.remove('active-play');
            if(btnShuffle) btnShuffle.classList.remove('active-play');
            if (activeMode === 'normal' && btnNormal) btnNormal.classList.add('active-play');
            if (activeMode === 'shuffle' && btnShuffle) btnShuffle.classList.add('active-play');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        if(typeof audioData !== 'undefined') {
            renderAudioContent();
        } else {
            container.innerHTML = '<p style="color:red; text-align:center;">Datenbank fehlt.</p>';
        }

    } catch (e) {
        console.error(e);
    }
</script>

</body>
</html>
