<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suaheli intensiv</title>
    <link rel="icon" type="image/png" href="cover.386x491.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<small id="version-display">v0.17</small>

<div class="container">
    <header>
        <h1>Suaheli intensiv</h1>
        <p><a href="index.html" style="color:white;">&larr; Zur√ºck</a></p>
    </header>

    <div class="content" id="audioContainer">
        <div style="text-align:center; padding:20px;">Lade Daten...</div>
    </div>
</div>

<div class="control-bar">
    <div class="status-bar" id="statusText">Bitte Auswahl treffen...</div>
    <div class="control-buttons">
        <button class="control-btn" onclick="stopPlayback()" style="background:#c0392b; border-color:#a93226;">
            <span>‚èπ</span> Stop
        </button>
        
        <button class="control-btn" onclick="resetCheckboxes()" style="background:#7f8c8d; border-color:#95a5a6;">
            <span>‚òí</span> Reset
        </button>

        <button class="control-btn" id="btn-loop" onclick="toggleLoop()">
            <span>üîÅ</span> Loop
        </button>

        <button class="control-btn" id="btn-shuffle" onclick="toggleShuffle()">
            <span>üîÄ</span> Zufall
        </button>

        <button class="control-btn" onclick="changeSpeed()">
            <span id="speed-icon">1.0x</span> Tempo
        </button>

        <button class="control-btn" id="btn-play-pause" onclick="togglePlayPause()" style="grid-column: span 2;">
            <span>‚ñ∂</span> Play
        </button>
        
        <button class="control-btn" id="btn-skip" onclick="skipTrack()">
            <span>‚è≠</span> Weiter
        </button>
    </div>
</div>

<script src="audio_data.js"></script>

<script>
    try {
        const container = document.getElementById('audioContainer');
        const statusText = document.getElementById('statusText');
        const playlistPlayer = new Audio();
        
        let playlist = [];       
        let currentTrackIndex = 0;
        let playbackMode = 'normal'; 
        let isPlaylistPlaying = false;
        let isPaused = false;
        let isLoopActive = false;
        let isShuffleActive = false;
        let currentSpeed = 1.0;
        let currentSingleAudio = null;

        const speedOptions = [0.75, 1.0, 1.25, 1.5]; 

        function renderAudioContent() {
            container.innerHTML = ''; 

            const chapters = Object.keys(audioData).sort((a, b) => 
                a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
            );

            chapters.forEach(chapterKey => {
                const chapterDetails = document.createElement('details');
                const chapterSummary = document.createElement('summary');
                chapterSummary.textContent = "Kapitel " + chapterKey;
                chapterDetails.appendChild(chapterSummary);

                const chapterContent = document.createElement('div');
                chapterContent.style.paddingLeft = "10px";

                // "Alle ausw√§hlen" f√ºr das gesamte Kapitel
                const chapSelectAll = document.createElement('label');
                chapSelectAll.className = 'select-all-row';
                chapSelectAll.innerHTML = `<input type="checkbox" class="chap-cb"> Kapitel ${chapterKey} (Alle w√§hlen)`;
                chapSelectAll.querySelector('input').onclick = (e) => toggleChildren(e, chapterDetails);
                chapterContent.appendChild(chapSelectAll);

                const tables = Object.keys(audioData[chapterKey]).sort((a, b) => {
                    const isVokA = a.includes('Vok');
                    const isVokB = b.includes('Vok');
                    if (isVokA && !isVokB) return -1;
                    if (!isVokA && isVokB) return 1;
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                });

                tables.forEach(tableKey => {
                    const tableDetails = document.createElement('details');
                    const tableSummary = document.createElement('summary');

                    let displayName = tableKey;
                    if (tableKey.includes('Vok')) {
                        const parts = tableKey.split('-');
                        displayName = parts.length > 1 ? "Vokabeln " + parts[1] : "Vokabeln";
                        tableSummary.style.color = "#d35400"; 
                    } else {
                        displayName = "Tabelle " + tableKey;
                    }

                    tableSummary.textContent = displayName;
                    tableDetails.appendChild(tableSummary);

                    const tableContent = document.createElement('div');
                    tableContent.style.padding = "10px";
                    tableContent.style.backgroundColor = "#f9f9f9";

                    // "Alle ausw√§hlen" f√ºr diese Tabelle
                    const tableSelectAll = document.createElement('label');
                    tableSelectAll.className = 'select-all-row';
                    tableSelectAll.style.background = "#e1e1e1";
                    tableSelectAll.innerHTML = `<input type="checkbox" class="table-cb"> ${displayName} (Alle w√§hlen)`;
                    tableSelectAll.querySelector('input').onclick = (e) => toggleChildren(e, tableDetails);
                    tableContent.appendChild(tableSelectAll);

                    const tracks = audioData[chapterKey][tableKey];
                    tracks.forEach(track => {
                        const row = document.createElement('div');
                        row.className = 'audio-row';
                        row.id = 'row-' + convertPathToId(track.path);

                        const trackCheckbox = document.createElement('input');
                        trackCheckbox.type = "checkbox";
                        trackCheckbox.className = "track-cb";
                        trackCheckbox.value = track.path;
                        trackCheckbox.dataset.label = displayName + " - " + track.index; 

                        const label = document.createElement('span');
                        label.className = 'audio-label';
                        label.textContent = track.index + ".";

                        const playButton = document.createElement('button');
                        playButton.className = 'play-btn';
                        playButton.innerHTML = '&#9654;'; // Play symbol
                        playButton.onclick = () => {
                            window.stopPlayback();
                            playlistPlayer.src = track.path;
                            playlistPlayer.playbackRate = currentSpeed;
                            playlistPlayer.play();
                            statusText.textContent = track.label;
                            highlightRow(row.id);
                        };

                        row.appendChild(trackCheckbox);
                        row.appendChild(label);
                        row.appendChild(playButton);
                        tableContent.appendChild(row);
                    });

                    tableDetails.appendChild(tableContent);
                    chapterContent.appendChild(tableDetails);
                });

                chapterDetails.appendChild(chapterContent);
                container.appendChild(chapterDetails);
            });
        }

        function toggleChildren(e, parentElement) {
            e.stopPropagation(); 
            const isChecked = e.target.checked;
            parentElement.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = isChecked);
        }

        window.resetCheckboxes = function() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            statusText.textContent = "Auswahl aufgehoben.";
            playlist = [];
            window.stopPlayback();
        };

        window.changeSpeed = function() {
            let index = speedOptions.indexOf(currentSpeed);
            index = (index + 1) % speedOptions.length;
            currentSpeed = speedOptions[index];
            const icon = document.getElementById('speed-icon');
            if(icon) icon.textContent = currentSpeed + "x";
            if (playlistPlayer) playlistPlayer.playbackRate = currentSpeed;
            playlistPlayer.playbackRate = currentSpeed;
        };

        window.toggleLoop = function() {
            isLoopActive = !isLoopActive;
            const btnLoop = document.getElementById('btn-loop');
            if (btnLoop) btnLoop.classList.toggle('loop-on', isLoopActive);
        };

        window.toggleShuffle = function() {
            isShuffleActive = !isShuffleActive;
            const btnShuffle = document.getElementById('btn-shuffle');
            if (btnShuffle) btnShuffle.classList.toggle('active-play', isShuffleActive);

            // Wenn eine Playlist l√§uft und Shuffle aktiviert/deaktiviert wird,
            // erstelle die Playlist aus den aktuell ausgew√§hlten Checkboxen neu.
            if (isPlaylistPlaying && isShuffleActive && playlist.length > 0) {
                const currentTrack = playlist[currentTrackIndex];
                // Baue die Playlist aus den Checkboxen neu, aber ohne den aktuellen Track
                let newPlaylist = Array.from(document.querySelectorAll('.track-cb:checked'))
                                       .map(cb => ({ path: cb.value, label: cb.dataset.label, domId: 'row-' + convertPathToId(cb.value) }))
                                       .filter(track => track.path !== currentTrack.path);
                shuffleArray(newPlaylist);
                playlist = [currentTrack, ...newPlaylist]; // Setze den aktuellen Track an den Anfang
                currentTrackIndex = 0; // Setze den Index zur√ºck, da der aktuelle Track jetzt bei 0 ist
                statusText.textContent = "Zufall an: N√§chster Track ist zuf√§llig.";
            }
        };

        function setupPlaylist(mode) {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.track-cb:checked'));
            if (selectedCheckboxes.length === 0) {
                alert("Bitte w√§hlen Sie zuerst Audio-Dateien aus.");
                return false;
            }
            
            playlist = selectedCheckboxes.map(cb => ({
                path: cb.value,
                label: cb.dataset.label,
                domId: 'row-' + convertPathToId(cb.value)
            }));
            playbackMode = mode;

            if (mode === 'shuffle') shuffleArray(playlist);
            currentTrackIndex = 0;
            return true;
        }

        function startPlaylist() {
            const mode = isShuffleActive ? 'shuffle' : 'normal';
            if (!setupPlaylist(mode)) return; // Bricht ab, wenn keine Tracks ausgew√§hlt sind

            isPlaylistPlaying = true;
            isPaused = false;
            playNext();
            updatePlayPauseButton(true); // Button sofort aktualisieren
        }

        window.togglePlayPause = function() {
            // Wenn nichts ausgew√§hlt ist oder keine Playlist l√§uft, starte sie.
            if (!isPlaylistPlaying) {
                startPlaylist();
                return;
            }

            // Wenn die Playlist l√§uft, pausiere oder setze sie fort.
            isPaused = !isPaused; // Zustand umkehren
            if (isPaused) {
                playlistPlayer.pause();
                statusText.textContent = "Pausiert";
                updatePlayPauseButton(false);
            } else {
                playlistPlayer.play();
                statusText.textContent = playlist[currentTrackIndex].label;
                updatePlayPauseButton(true);
            }
        };

        window.skipTrack = function() {
            if (isPlaylistPlaying && !isPaused) {
                currentTrackIndex++;
                playNext();
            }
        };

        window.stopPlayback = function() {
            isPlaylistPlaying = false;
            isPaused = false;
            // Reset playlist to allow re-shuffling etc.
            playlist = []; 
            playlistPlayer.pause();
            if (currentSingleAudio) {
                currentSingleAudio.pause();
                currentSingleAudio = null;
            }
            statusText.textContent = "Gestoppt.";
            removeHighlights();
            updatePlayPauseButton(false);
        };

        function convertPathToId(path) {
            return path.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function playNext() {
            if (!isPlaylistPlaying) return;
            if (currentTrackIndex >= playlist.length) {
                if (isLoopActive) {
                    currentTrackIndex = 0;
                } else {
                    window.stopPlayback();
                    statusText.textContent = "Wiedergabe beendet.";
                    return;
                }
            }
            const track = playlist[currentTrackIndex];
            highlightRow(track.domId);
            statusText.textContent = track.label;
            playlistPlayer.src = track.path;
            playlistPlayer.playbackRate = currentSpeed;
            playlistPlayer.play().catch(e => console.log("Fehler:", e));
            
            playlistPlayer.onended = () => {
                currentTrackIndex++;
                playNext();
            };
        }

        function highlightRow(domId) {
            removeHighlights();
            const row = document.getElementById(domId);
            if (row) {
                row.classList.add('playing-row');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function removeHighlights() {
            document.querySelectorAll('.playing-row').forEach(el => el.classList.remove('playing-row'));
        }

        function updatePlayPauseButton(isPlaying) {
            const btn = document.getElementById('btn-play-pause');
            if (!btn) return;
            if (isPlaying) {
                btn.innerHTML = '<span>‚ùö‚ùö</span> Pause';
                btn.classList.add('active-play');
            } else {
                btn.innerHTML = '<span>‚ñ∂</span> Play';
                btn.classList.remove('active-play');
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        if(typeof audioData !== 'undefined') {
            renderAudioContent();
        } else {
            container.innerHTML = '<p style="color:red; text-align:center;">Datenbank fehlt.</p>';
        }

    } catch (e) {
        console.error(e);
    }
</script>

</body>
</html>
