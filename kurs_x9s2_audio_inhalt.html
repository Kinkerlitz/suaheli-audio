<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suaheli intensiv</title>
    <link rel="icon" type="image/png" href="cover.386x491.png">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Optimierte Ausrichtung f√ºr Checkboxen in den Akkordeon-Headern */
        summary {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px !important;
            position: relative; /* Wichtig f√ºr Hintergr√ºnde */
        }
        summary input[type="checkbox"] {
            margin: 0;
            transform: scale(1.3);
            cursor: pointer;
            z-index: 2; /* Checkbox muss √ºber dem Hintergrund liegen */
        }

        /* NEU: Spezieller Stil f√ºr Kapitel-Header mit Hintergrundbild */
        summary.chapter-summary {
            /* Das Bild wird im JS gesetzt. Hier definieren wir, wie es sich verh√§lt.
               'cover' sorgt daf√ºr, dass es den Bereich f√ºllt, ohne verzerrt zu sein.
            */
            background-size: cover;
            background-position: center right; /* Fokus eher rechts */
            border-bottom: 1px solid rgba(0,0,0,0.1);
            min-height: 50px; /* Mindesth√∂he f√ºr gute Optik */
        }
        
        /* NEU: Container f√ºr den zweizeiligen Text */
        .header-text {
            display: flex;
            flex-direction: column;
            line-height: 1.3;
            justify-content: center;
            flex-grow: 1;
            z-index: 2; /* Text muss √ºber dem Hintergrund liegen */
        }

        /* Zeile 1: Die ID (z.B. C1.1) - Fett und dunkel */
        .header-id {
            font-weight: 800;
            font-size: 0.9rem;
            color: #2c3e50;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.8); /* Leichter Schatten f√ºr Lesbarkeit */
        }

        /* Zeile 2: Die Beschreibung - Normal und etwas heller */
        .header-desc {
            font-weight: 400;
            font-size: 0.95rem;
            color: #444; /* Etwas dunkler gemacht f√ºr Kontrast auf Hintergrund */
             text-shadow: 1px 1px 1px rgba(255,255,255,0.8);
            margin-top: 2px;
        }
        
        /* Spezielle Farbe f√ºr Vokabel-IDs */
        .is-vok .header-id {
            color: #d35400;
        }
    </style>
</head>
<body>

<small id="version-display">v0.22 (Kapitel-Hintergr√ºnde)</small>

<div class="container">
    <header>
        <h1>Suaheli intensiv</h1>
        <p><a href="index.html" style="color:white;">&larr; Zur√ºck</a></p>
    </header>

    <div class="content" id="audioContainer">
        <div style="text-align:center; padding:20px;">Lade Daten...</div>
    </div>
</div>

<div class="control-bar">
    <div class="status-bar" id="statusText">Bitte Auswahl treffen...</div>
    <div class="control-buttons">
        <button class="control-btn" onclick="stopPlayback()" style="background:#c0392b; border-color:#a93226;">
            <span>‚èπ</span> Stop
        </button>
        
        <button class="control-btn" onclick="resetCheckboxes()" style="background:#7f8c8d; border-color:#95a5a6;">
            <span>‚òí</span> Reset
        </button>

        <button class="control-btn" id="btn-loop" onclick="toggleLoop()">
            <span>üîÅ</span> Loop
        </button>

        <button class="control-btn" id="btn-shuffle" onclick="toggleShuffle()">
            <span>üîÄ</span> Zufall
        </button>

        <button class="control-btn" onclick="changeSpeed()">
            <span id="speed-icon">1.0x</span> Tempo
        </button>

        <button class="control-btn" id="btn-play-pause" onclick="togglePlayPause()" style="grid-column: span 2;">
            <span>‚ñ∂</span> Play
        </button>
        
        <button class="control-btn" id="btn-skip" onclick="skipTrack()">
            <span>‚è≠</span> Weiter
        </button>
    </div>
</div>

<script src="audio_data.js"></script>

<script>
    // Mapping der Kapitel-IDs auf die Klarnamen gem√§√ü CSV
    const chapterNames = {
        "C1.1": "C1.1 Identit√§t und Zust√§nde",
        "C1.2": "C1.2 Handlungen in der Gegenwart",
        "C1.3": "C1.3 Ort und Kontext",
        "C2.1": "C2.1 Der Plural (Wir, Ihr, Sie)",
        "C2.2": "C2.2 Besitz und Familie",
        "C2.3": "C2.3 Nomenklassen und Objekte",
        "C3.1": "C3.1 Vergangenheit und Zukunft",
        "C3.2": "C3.2 Zahlen und Mengen",
        "C4.1": "C4.1 Das Perfekt",
        "C4.2": "C4.2 Verben umbauen",
        "C5.1": "C5.1 Relativs√§tze und W√ºnsche",
        "C5.2": "C5.2 Bedingungen und Befehle",
        "D1.1": "D1.1 Im Alltag"
    };

    // NEU: Liste der Hintergrundbilder (alphabetisch sortiert aus Ihrem 'ls' Befehl)
    // HINWEIS: Diese Dateien m√ºssen im Unterordner 'backgrounds/' liegen.
    const backgroundImages = [
        'Pastell-Beige & Organisches Netzwerk.jpg',
        'Pastell-Creme Champagner & Diamant-Strukturen.jpg',
        'Pastell-Eisblau & Polyeder-Schwarm.jpg',
        'Pastell-Flieder & Organische Wellen.jpg',
        'Pastell-Grau & Sternf√∂rmiges Liniengeflecht.jpg',
        'Pastell-Hellblau & Geometrisches Netzwerk.jpg',
        'Pastell-Koralle & Ineinandergreifende Prismen.jpg',
        'Pastell-Lavendel & Vertikale Strukturen.jpg',
        'Pastell-Meerschaumgr√ºn & Schwebende Geometrie.jpg',
        'Pastell-Mintgr√ºn & Organische Linien.jpg',
        'Pastell-Pfirsich & Geschwungene Ebenen.jpg',
        'Pastell-Ros√© & Polygone.jpg',
        'Pastell-Zartrosa & Abstraktes Mosaik.jpg',
        'Pastell-Zitronengelb & Hexagone Netzwerk.jpg',
        'PastellTuerkis.jpg'
    ];

    try {
        const container = document.getElementById('audioContainer');
        const statusText = document.getElementById('statusText');
        const playlistPlayer = new Audio();
        
        let playlist = [];       
        let currentTrackIndex = 0;
        let isPlaylistPlaying = false;
        let isPaused = false;
        let isLoopActive = false;
        let isShuffleActive = false;
        let currentSpeed = 1.0;
        let currentSingleAudio = null;

        const speedOptions = [0.75, 1.0, 1.25, 1.5]; 

        function renderAudioContent() {
            container.innerHTML = ''; 

            const chapters = Object.keys(audioData).sort((a, b) => 
                a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
            );

            // WICHTIG: Wir f√ºgen hier den 'index' hinzu, um durch die Bilder zu iterieren
            chapters.forEach((chapterKey, index) => {
                const chapterDetails = document.createElement('details');
                const chapterSummary = document.createElement('summary');
                
                // NEU: Klasse f√ºr CSS und Berechnung des Hintergrundbilds
                chapterSummary.className = 'chapter-summary';
                
                // Wir nutzen den Modulo-Operator (%), damit die Bilder wieder von vorne beginnen,
                // falls es mehr Kapitel als Bilder gibt.
                const imageIndex = index % backgroundImages.length;
                const imageName = backgroundImages[imageIndex];
                
                // NEU: Setzen des Hintergrunds.
                // Trick: Wir legen einen halbtransparenten wei√üen Verlauf (linear-gradient) √úBER das Bild.
                // Das macht den schwarzen Text viel besser lesbar.
                chapterSummary.style.backgroundImage = `
                    linear-gradient(to right, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 70%, rgba(255,255,255,0.4) 100%),
                    url('backgrounds/${imageName}')
                `;

                
                // 1. Checkbox f√ºr Kapitel
                const chapCb = document.createElement('input');
                chapCb.type = 'checkbox';
                chapCb.className = 'chap-cb';
                chapCb.onclick = (e) => toggleChildren(e, chapterDetails);
                
                // 2. Zweizeiliger Header f√ºr Kapitel
                const textContainer = document.createElement('div');
                textContainer.className = 'header-text';

                const line1 = document.createElement('span');
                line1.className = 'header-id';
                line1.textContent = chapterKey;

                const line2 = document.createElement('span');
                line2.className = 'header-desc';
                
                let fullTitle = chapterNames[chapterKey] || "";
                let description = fullTitle.replace(chapterKey, "").trim(); 
                line2.textContent = description || "Kapitel√ºbersicht";

                textContainer.appendChild(line1);
                textContainer.appendChild(line2);

                chapterSummary.appendChild(chapCb);
                chapterSummary.appendChild(textContainer);
                chapterDetails.appendChild(chapterSummary);

                const chapterContent = document.createElement('div');
                chapterContent.style.paddingLeft = "10px";

                const tables = Object.keys(audioData[chapterKey]).sort((a, b) => {
                    const isVokA = a.includes('Vok');
                    const isVokB = b.includes('Vok');
                    if (isVokA && !isVokB) return -1;
                    if (!isVokA && isVokB) return 1;
                    return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
                });

                tables.forEach(tableKey => {
                    const tableDetails = document.createElement('details');
                    const tableSummary = document.createElement('summary');
                    // Tabellen-Header bekommen KEIN Hintergrundbild, bleiben Standard

                    let idText = "";
                    let descText = "";
                    let isVok = false;

                    if (tableKey.includes(',')) {
                        const parts = tableKey.split(',');
                        idText = parts[0].trim(); 
                        descText = parts.slice(1).join(',').trim();
                    } else if (tableKey.includes('Vok')) {
                        isVok = true;
                        idText = tableKey;
                        const parts = tableKey.split('-');
                        descText = parts.length > 1 ? "Vokabeln Teil " + parts[1] : "Vokabeln";
                    } else {
                        idText = tableKey;
                        descText = "Tabelle";
                    }

                    if (tableKey.includes('Vok')) isVok = true;

                    const tableCb = document.createElement('input');
                    tableCb.type = 'checkbox';
                    tableCb.className = 'table-cb';
                    tableCb.onclick = (e) => toggleChildren(e, tableDetails);

                    const tableTextContainer = document.createElement('div');
                    tableTextContainer.className = 'header-text';
                    if (isVok) tableTextContainer.classList.add('is-vok');

                    const tLine1 = document.createElement('span');
                    tLine1.className = 'header-id';
                    tLine1.textContent = idText;

                    const tLine2 = document.createElement('span');
                    tLine2.className = 'header-desc';
                    tLine2.textContent = descText;

                    tableTextContainer.appendChild(tLine1);
                    tableTextContainer.appendChild(tLine2);

                    tableSummary.appendChild(tableCb);
                    tableSummary.appendChild(tableTextContainer);
                    tableDetails.appendChild(tableSummary);

                    const tableContent = document.createElement('div');
                    tableContent.style.padding = "5px 10px";
                    tableContent.style.backgroundColor = "#f9f9f9";

                    const tracks = audioData[chapterKey][tableKey];
                    tracks.forEach(track => {
                        const row = document.createElement('div');
                        row.className = 'audio-row';
                        row.id = 'row-' + convertPathToId(track.path);

                        const trackCheckbox = document.createElement('input');
                        trackCheckbox.type = "checkbox";
                        trackCheckbox.className = "track-cb";
                        trackCheckbox.value = track.path;
                        trackCheckbox.dataset.label = idText + " (" + track.index + ")"; 

                        const label = document.createElement('span');
                        label.className = 'audio-label';
                        label.textContent = track.index + ".";

                        const playButton = document.createElement('button');
                        playButton.className = 'play-btn';
                        playButton.innerHTML = '&#9654;'; 
                        playButton.onclick = () => {
                            window.stopPlayback();
                            playlistPlayer.src = track.path;
                            playlistPlayer.playbackRate = currentSpeed;
                            playlistPlayer.play();
                            statusText.textContent = trackCheckbox.dataset.label;
                            highlightRow(row.id);
                        };

                        row.appendChild(trackCheckbox);
                        row.appendChild(label);
                        row.appendChild(playButton);
                        tableContent.appendChild(row);
                    });

                    tableDetails.appendChild(tableContent);
                    chapterContent.appendChild(tableDetails);
                });

                chapterDetails.appendChild(chapterContent);
                container.appendChild(chapterDetails);
            });
        }

        function toggleChildren(e, parentElement) {
            e.stopPropagation(); 
            const isChecked = e.target.checked;
            parentElement.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = isChecked);
        }

        window.resetCheckboxes = function() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            statusText.textContent = "Auswahl aufgehoben.";
            playlist = [];
            window.stopPlayback();
        };

        window.changeSpeed = function() {
            let index = speedOptions.indexOf(currentSpeed);
            index = (index + 1) % speedOptions.length;
            currentSpeed = speedOptions[index];
            const icon = document.getElementById('speed-icon');
            if(icon) icon.textContent = currentSpeed + "x";
            playlistPlayer.playbackRate = currentSpeed;
        };

        window.toggleLoop = function() {
            isLoopActive = !isLoopActive;
            const btnLoop = document.getElementById('btn-loop');
            if (btnLoop) btnLoop.classList.toggle('loop-on', isLoopActive);
        };

        window.toggleShuffle = function() {
            isShuffleActive = !isShuffleActive;
            const btnShuffle = document.getElementById('btn-shuffle');
            if (btnShuffle) btnShuffle.classList.toggle('active-play', isShuffleActive);
        };

        function setupPlaylist() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.track-cb:checked'));
            if (selectedCheckboxes.length === 0) {
                alert("Bitte w√§hlen Sie zuerst Audio-Dateien aus.");
                return false;
            }
            
            playlist = selectedCheckboxes.map(cb => ({
                path: cb.value,
                label: cb.dataset.label,
                domId: 'row-' + convertPathToId(cb.value)
            }));

            if (isShuffleActive) shuffleArray(playlist);
            currentTrackIndex = 0;
            return true;
        }

        function startPlaylist() {
            if (!setupPlaylist()) return; 
            isPlaylistPlaying = true;
            isPaused = false;
            playNext();
            updatePlayPauseButton(true);
        }

        window.togglePlayPause = function() {
            if (!isPlaylistPlaying) {
                startPlaylist();
                return;
            }
            isPaused = !isPaused; 
            if (isPaused) {
                playlistPlayer.pause();
                statusText.textContent = "Pausiert";
                updatePlayPauseButton(false);
            } else {
                playlistPlayer.play();
                statusText.textContent = playlist[currentTrackIndex].label;
                updatePlayPauseButton(true);
            }
        };

        window.skipTrack = function() {
            if (isPlaylistPlaying) {
                currentTrackIndex++;
                playNext();
            }
        };

        window.stopPlayback = function() {
            isPlaylistPlaying = false;
            isPaused = false;
            playlist = []; 
            playlistPlayer.pause();
            statusText.textContent = "Gestoppt.";
            removeHighlights();
            updatePlayPauseButton(false);
        };

        function convertPathToId(path) {
            return path.replace(/[^a-zA-Z0-9]/g, '_');
        }

        function playNext() {
            if (!isPlaylistPlaying) return;
            if (currentTrackIndex >= playlist.length) {
                if (isLoopActive) {
                    currentTrackIndex = 0;
                } else {
                    window.stopPlayback();
                    statusText.textContent = "Wiedergabe beendet.";
                    return;
                }
            }
            const track = playlist[currentTrackIndex];
            highlightRow(track.domId);
            statusText.textContent = track.label;
            playlistPlayer.src = track.path;
            playlistPlayer.playbackRate = currentSpeed;
            playlistPlayer.play().catch(e => console.log("Fehler:", e));
            
            playlistPlayer.onended = () => {
                currentTrackIndex++;
                playNext();
            };
        }

        function highlightRow(domId) {
            removeHighlights();
            const row = document.getElementById(domId);
            if (row) {
                row.classList.add('playing-row');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function removeHighlights() {
            document.querySelectorAll('.playing-row').forEach(el => el.classList.remove('playing-row'));
        }

        function updatePlayPauseButton(isPlaying) {
            const btn = document.getElementById('btn-play-pause');
            if (!btn) return;
            if (isPlaying) {
                btn.innerHTML = '<span>‚ùö‚ùö</span> Pause';
                btn.classList.add('active-play');
            } else {
                btn.innerHTML = '<span>‚ñ∂</span> Play';
                btn.classList.remove('active-play');
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        if(typeof audioData !== 'undefined') {
            renderAudioContent();
        } else {
            container.innerHTML = '<p style="color:red; text-align:center;">Datenbank fehlt.</p>';
        }

    } catch (e) {
        console.error(e);
    }
</script>

</body>
</html>